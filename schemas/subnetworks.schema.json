{
    "$id": "subnetworks.schema.json",
    "$schema": "http://json-schema.org/draft-07/schema#",
    "title": "Subnetworks",
    "definitions": {
        "private": {
            "type": "object",
            "additionalProperties": false,
            "required": [
                "ip_cidr_range",
                "region"
            ],
            "properties": {
                "ip_cidr_range": {
                    "type": "string",
                    "description": "IP space allocated to this subnetwork in CIDR format.",
                    "examples": [
                        "192.168.0.0/24"
                    ],
                    "pattern": "^([0-9]{1,3}\\.){3}[0-9]{1,3}\\/(([0-9]|[1-2][0-9]|3[0-2]))?$"
                },
                "name": {
                    "type": [
                        "string",
                        "null"
                    ],
                    "description": "if this field is not provided ip_cidr_range value will be dynamically generated based on the ip_cidr_range. WARNING, if this field is not set changing the ip_cidr_range will change the name dynamically generated.",
                    "pattern": "^(?:[a-z](?:[-a-z0-9]{0,61}[a-z0-9])?)$",
                    "examples": [
                        "<prefix>-<environment>-<network>-subnet-<192-168-0-0-24>"
                    ],
                    "default": null
                },
                "purpose": {
                    "type": "string",
                    "enum": [
                        "PRIVATE",
                        "PRIVATE_SERVICE_CONNECT",
                        "INTERNAL_HTTPS_LOAD_BALANCER"
                    ],
                    "default": "PRIVATE"
                },
                "description": {
                    "type": [
                        "string",
                        "null"
                    ],
                    "description": "Description of this subnetwork.",
                    "default": null
                },
                "secondary_subnetworks": {
                    "type": "array",
                    "items": {
                        "type": "object",
                        "additionalProperties": false,
                        "properties": {
                            "nat_group_id": {
                                "type": "string",
                                "examples": ["nat-group"]
                            },
                            "ip_cidr_range": {
                                "type": "string",
                                "description": "IP space allocated to this subnetwork in CIDR format.",
                                "examples": ["192.168.0.0/24"],
                                "pattern": "^([0-9]{1,3}\\.){3}[0-9]{1,3}\\/(([0-9]|[1-2][0-9]|3[0-2]))?$"
                            }
                        },
                        "required": [
                            "ip_cidr_range"
                        ]
                    }
                },
                "private_ip_google_access": {
                    "type": "string",
                    "description": "(OPTIONAL) Provide access to Google Cloud APIs from this subnet for instances without a public ip address.",
                    "enum": [
                        "ENABLED",
                        "DISABLED"
                    ],
                    "default": "ENABLED"
                },
                "log_config": {
                    "type": "object",
                    "properties": {
                        "enabled": {
                            "type": "boolean",
                            "description": "Enable/disable VPC Flow Logs for this subnet.",
                            "default": false
                        },
                        "aggregation_interval": {
                            "type": "string",
                            "description": "Toggles the aggregation interval for collecting flow logs. Increasing the interval time will reduce the amount of generated flow logs for long lasting connections.",
                            "enum": [
                                "INTERVAL_5_SEC",
                                "INTERVAL_30_SEC",
                                "INTERVAL_1_MIN",
                                "INTERVAL_5_MIN",
                                "INTERVAL_10_MIN",
                                "INTERVAL_15_MIN"
                            ],
                            "default": "INTERVAL_5_SEC"
                        },
                        "flow_sampling": {
                            "type": "integer",
                            "description": "Set the sampling rate of VPC flow logs within the subnetwork where 100 means all collected logs are reported, 50 means half of all collected logs are reported and 0 means no logs are reported.",
                            "minimum": 0,
                            "maximum": 100,
                            "default": 50
                        },
                        "metadata": {
                            "type": "string",
                            "enum": [
                                "INCLUDE_ALL_METADATA",
                                "EXCLUDE_ALL_METADATA",
                                "CUSTOM_METADATA"
                            ],
                            "default": "INCLUDE_ALL_METADATA"
                        },
                        "metadata_fields": {
                            "type": "array",
                            "items": {
                                "type": "string"
                            },
                            "default": [],
                            "description": "List of supported fields can be found at https://cloud.google.com/vpc/docs/flow-logs#record_format"
                        }
                    }
                },
                "cloud_nat": {
                    "type": "object",
                    "properties": {
                        "subnetworks_to_nat": {
                            "type": "string",
                            "enum": [
                                "DISABLED",
                                "ALL_SUBNETWORKS",
                                "ALL_SECONDARY_SUBNETWORKS",
                                "PRIMARY_SUBNETWORKS",
                                "SELECTED_SECONDARY_SUBNETWORKS",
                                "PRIMARY_SUBNETWORK_SELECTED_SECONDARY_SUBNETWORKS"
                            ],
                            "default": "DISABLED"
                        },
                        "nat_group_id": {
                            "type": "string",
                            "default": "nat-group"
                        }
                    },
                    "required": [
                        "subnetworks_to_nat",
                        "nat_group_id"
                    ],
                    "default": {}
                },
                "region": {
                    "$ref": "regions.schema.json#/definitions/region"
                }
            }
        },
        "private_service_connect": {
            "type": "object",
            "additionalProperties": false,
            "required": [
                "ip_cidr_range",
                "region"
            ],
            "properties": {
                "ip_cidr_range": {
                    "type": "string",
                    "description": "IP space allocated to this subnetwork in CIDR format.",
                    "examples": [
                        "192.168.0.0/24"
                    ],
                    "pattern": "^([0-9]{1,3}\\.){3}[0-9]{1,3}\\/(([0-9]|[1-2][0-9]|3[0-2]))?$"
                },
                "name": {
                    "type": [
                        "string",
                        "null"
                    ],
                    "description": "if this field is not provided ip_cidr_range value will be dynamically generated based on the ip_cidr_range. WARNING, if this field is not set changing the ip_cidr_range will change the name dynamically generated.",
                    "pattern": "^(?:[a-z](?:[-a-z0-9]{0,61}[a-z0-9])?)$",
                    "examples": [
                        "<prefix>-<environment>-<network>-subnet-<192-168-0-0-24>"
                    ],
                    "default": null
                },
                "purpose": {
                    "type": "string",
                    "enum": [
                        "PRIVATE",
                        "PRIVATE_SERVICE_CONNECT",
                        "INTERNAL_HTTPS_LOAD_BALANCER"
                    ],
                    "default": "PRIVATE"
                },
                "description": {
                    "type": [
                        "string",
                        "null"
                    ],
                    "description": "Description of this subnetwork.",
                    "default": null
                },
                "region": {
                    "$ref": "regions.schema.json#/definitions/region"
                }
            }
        },
        "internal_https_load_balancer": {
            "type": "object",
            "additionalProperties": false,
            "required": [
                "ip_cidr_range",
                "region"
            ],
            "properties": {
                "ip_cidr_range": {
                    "type": "string",
                    "description": "IP space allocated to this subnetwork in CIDR format.",
                    "examples": [
                        "192.168.0.0/24"
                    ],
                    "pattern": "^([0-9]{1,3}\\.){3}[0-9]{1,3}\\/(([0-9]|[1-2][0-9]|3[0-2]))?$"
                },
                "name": {
                    "type": [
                        "string",
                        "null"
                    ],
                    "description": "if this field is not provided ip_cidr_range value will be dynamically generated based on the ip_cidr_range. WARNING, if this field is not set changing the ip_cidr_range will change the name dynamically generated.",
                    "pattern": "^(?:[a-z](?:[-a-z0-9]{0,61}[a-z0-9])?)$",
                    "examples": [
                        "<prefix>-<environment>-<network>-subnet-<192-168-0-0-24>"
                    ],
                    "default": null
                },
                "purpose": {
                    "type": "string",
                    "enum": [
                        "PRIVATE",
                        "PRIVATE_SERVICE_CONNECT",
                        "INTERNAL_HTTPS_LOAD_BALANCER"
                    ],
                    "default": "PRIVATE"
                },
                "description": {
                    "type": [
                        "string",
                        "null"
                    ],
                    "description": "Description of this subnetwork.",
                    "default": null
                },
                "region": {
                    "$ref": "regions.schema.json#/definitions/region"
                },
                "role": {
                    "type": "string",
                    "enum": [
                        "BACKUP",
                        "ACTIVE"
                    ],
                    "default": "ACTIVE"
                }
            }
        },
        "subnetworks": {
            "type": "array",
            "uniqueItems": true,
            "minItems": 0,
            "maxItems": 100,
            "items": {
                "type": "object",
                "title": "Subnetwork",
                "allOf": [
                    {
                        "title": "Private",
                        "description": "A subnetwork with purpose set to PRIVATE is a user-created subnetwork that is reserved for Google Compute Engine instances.",
                        "if": {
                            "properties": {
                                "purpose": {
                                    "const": "PRIVATE"
                                }
                            }
                        },
                        "then": {
                            "$ref": "#/definitions/private"
                        }
                    },
                    {
                        "title": "Private Service Connect",
                        "description": "A subnetwork with purpose set to PRIVATE_SERVICE_CONNECT is a user-created subnetwork that is reserved for Private Service Connect Internal Load Balancing.",
                        "if": {
                            "properties": {
                                "purpose": {
                                    "const": "PRIVATE_SERVICE_CONNECT"
                                }
                            },
                            "required": [
                                "purpose"
                            ]
                        },
                        "then": {
                            "$ref": "#/definitions/private_service_connect"
                        }
                    },
                    {
                        "title": "Internal HTTP(s) Load Balancer",
                        "description": "A subnetwork with purpose set to INTERNAL_HTTPS_LOAD_BALANCER is a user-created subnetwork that is reserved for Internal HTTP(S) Load Balancing.",
                        "if": {
                            "properties": {
                                "purpose": {
                                    "const": "INTERNAL_HTTPS_LOAD_BALANCER"
                                }
                            },
                            "required": [
                                "purpose"
                            ]
                        },
                        "then": {
                            "$ref": "#/definitions/internal_https_load_balancer"
                        }
                    }
                ]
            }
        }
    }
}