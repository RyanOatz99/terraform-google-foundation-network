{
    "$schema": "http://json-schema.org/draft-07/schema#",
    "$id": "https://example.com/schemas/foundation",
    "type": "array",
    "items": {
        "$ref": "#/$defs/networking"
    },
    "$defs": {
        "networking": {
            "$id": "/schemas/networking",
            "type": "object",
            "properties": {
                "name": {
                    "type": "string"
                },
                "description": {
                    "type": "string",
                    "default": null
                },
                "mtu": {
                    "type": "number",
                    "enum": [
                        1460,
                        1500
                    ],
                    "default": 1460
                },
                "private_google_access": {
                    "type": "string",
                    "enum": [
                        "RESTRICTED",
                        "PRIVATE",
                        "DISABLED"
                    ],
                    "default": "DISABLED"
                },
                "routing_mode": {
                    "type": "string",
                    "enum": [
                        "GLOBAL",
                        "REGIONAL"
                    ],
                    "default": "REGIONAL"
                },
                "subnetworks": {
                    "type": "array",
                    "items": {
                        "allOf": [
                            {
                                "type": "object",
                                "properties": {
                                    "purpose": {
                                        "type": "string",
                                        "enum": [
                                            "PRIVATE",
                                            "PRIVATE_SERVICE_CONNECT",
                                            "INTERNAL_HTTPS_LOAD_BALANCER"
                                        ]
                                    }
                                }
                            },
                            {
                                "if": {
                                    "properties": {
                                        "purpose": {
                                            "const": "PRIVATE"
                                        }
                                    }
                                },
                                "then": {
                                    "$ref": "/schemas/subnetworks_private"
                                }
                            },
                            {
                                "if": {
                                    "properties": {
                                        "purpose": {
                                            "const": "PRIVATE_SERVICE_CONNECT"
                                        }
                                    },
                                    "required": [
                                        "purpose"
                                    ]
                                },
                                "then": {
                                    "$ref": "/schemas/subnetworks_private_service_connect"
                                }
                            },
                            {
                                "if": {
                                    "properties": {
                                        "purpose": {
                                            "const": "INTERNAL_HTTPS_LOAD_BALANCER"
                                        }
                                    },
                                    "required": [
                                        "purpose"
                                    ]
                                },
                                "then": {
                                    "$ref": "/schemas/subnetworks_internal_https_load_balancer"
                                }
                            }
                        ]
                    }
                },
                "routes": {
                    "type": "array",
                    "items": {
                        "required": [
                            "next_hop_type"
                        ],
                        "allOf": [
                            {
                                "type": "object",
                                "properties": {
                                    "next_hop_type": {
                                        "type": "string",
                                        "enum": [
                                            "ADDRESS",
                                            "INTERNET_GATEWAY"
                                        ]
                                    }
                                }
                            },
                            {
                                "if": {
                                    "properties": {
                                        "next_hop_type": {
                                            "const": "ADDRESS"
                                        }
                                    },
                                    "required": [
                                        "next_hop_type"
                                    ]
                                },
                                "then": {
                                    "$ref": "/schemas/routes/nexthop/address"
                                }
                            },
                            {
                                "if": {
                                    "properties": {
                                        "next_hop_type": {
                                            "const": "INTERNET_GATEWAY"
                                        }
                                    },
                                    "required": [
                                        "next_hop_type"
                                    ]
                                },
                                "then": {
                                    "$ref": "/schemas/routes_nexthop_internet_gateway"
                                }
                            }
                        ]
                    }
                }
            },
            "additionalProperties": false
        },
        "subnetworks_shared": {
            "$id": "/schemas/subnetworks_shared",
            "type": "object",
            "properties": {
                "ip_cidr_range": {
                    "type": "string",
                    "description": "IP space allocated to this subnetwork in CIDR format.",
                    "example": "192.168.0.0/24",
                    "pattern": "^([0-9]{1,3}\\.){3}[0-9]{1,3}\\/(([0-9]|[1-2][0-9]|3[0-2]))?$"
                },
                "region": {
                    "$ref": "/schemas/regions"
                },
                "name": {
                    "type": "string",
                    "description": "(OPTIONAL) if this field is not provided ip_cidr_range value will be dynamically generated based on the ip_cidr_range. WARNING, if this field is not set changing the ip_cidr_range will change the name dynamically generated.",
                    "pattern": "^(?:[a-z](?:[-a-z0-9]{0,61}[a-z0-9])?)$",
                    "example": "<prefix>-<environment>-<network>-subnet-<192-168-0-0-24>",
                    "default": null
                },
                "description": {
                    "type": "string",
                    "description": "(OPTIONAL) Description of this subnetwork.",
                    "default": null
                },
                "purpose": true
            }
        },
        "subnetworks_private": {
            "$id": "/schemas/subnetworks_private",
            "unevaluatedProperties": false,
            "allOf": [
                {
                    "$ref": "/schemas/subnetworks_shared"
                },
                {
                    "type": "object",
                    "properties": {
                        "secondary_subnetworks": {
                            "type": "array",
                            "items": {
                                "type": "object",
                                "additionalProperties": false,
                                "properties": {
                                    "nat_group_id": {
                                        "type": "string",
                                        "example": "nat-group"
                                    },
                                    "ip_cidr_range": {
                                        "type": "string",
                                        "description": "IP space allocated to this subnetwork in CIDR format.",
                                        "example": "192.168.0.0/24",
                                        "pattern": "^([0-9]{1,3}\\.){3}[0-9]{1,3}\\/(([0-9]|[1-2][0-9]|3[0-2]))?$"
                                    }
                                },
                                "required": [
                                    "ip_cidr_range"
                                ]
                            }
                        },
                        "private_ip_google_access": {
                            "type": "string",
                            "description": "(OPTIONAL) Provide access to Google Cloud APIs from this subnet for instances without a public ip address.",
                            "enum": [
                                "ENABLED",
                                "DISABLED"
                            ],
                            "default": "ENABLED"
                        },
                        "log_config": {
                            "type": "object",
                            "properties": {
                                "enabled": {
                                    "type": "boolean",
                                    "description": "Enable/disable VPC Flow Logs for this subnet.",
                                    "default": false
                                },
                                "aggregation_interval": {
                                    "type": "string",
                                    "description": "Toggles the aggregation interval for collecting flow logs. Increasing the interval time will reduce the amount of generated flow logs for long lasting connections.",
                                    "enum": [
                                        "INTERVAL_5_SEC",
                                        "INTERVAL_30_SEC",
                                        "INTERVAL_1_MIN",
                                        "INTERVAL_5_MIN",
                                        "INTERVAL_10_MIN",
                                        "INTERVAL_15_MIN"
                                    ],
                                    "default": "INTERVAL_5_SEC"
                                },
                                "flow_sampling": {
                                    "type": "number",
                                    "description": "Set the sampling rate of VPC flow logs within the subnetwork where 100 means all collected logs are reported, 50 means half of all collected logs are reported and 0 means no logs are reported.",
                                    "minLength": 0,
                                    "maxLength": 100,
                                    "default": 50
                                },
                                "metadata": {
                                    "type": "string",
                                    "enum": [
                                        "INCLUDE_ALL_METADATA",
                                        "EXCLUDE_ALL_METADATA",
                                        "CUSTOM_METADATA"
                                    ],
                                    "default": "INCLUDE_ALL_METADATA"
                                },
                                "metadata_fields": {
                                    "type": "array",
                                    "items": {
                                        "type": "string"
                                    },
                                    "default": [],
                                    "description": "List of supported fields can be found at https://cloud.google.com/vpc/docs/flow-logs#record_format"
                                }
                            }
                        },
                        "cloud_nat": {
                            "type": "object",
                            "properties": {
                                "subnetworks_to_nat": {
                                    "type": "string",
                                    "enum": [
                                        "DISABLED",
                                        "ALL_SUBNETWORKS",
                                        "ALL_SECONDARY_SUBNETWORKS",
                                        "PRIMARY_SUBNETWORK",
                                        "SELECTED_SECONDARY_SUBNETWORKS",
                                        "PRIMARY_SUBNETWORK_SELECTED_SECONDARY_SUBNETWORKS"
                                    ],
                                    "default": "DISABLED"
                                },
                                "nat_group_id": {
                                    "type": "string",
                                    "default": "nat-group"
                                }
                            },
                            "required": [
                                "subnetworks_to_nat",
                                "nat_group_id"
                            ],
                            "default": {}
                        }
                    }
                }
            ]
        },
        "subnetworks_private_service_connect": {
            "$id": "/schemas/subnetworks_private_service_connect",
            "unevaluatedProperties": false,
            "allOf": [
                {
                    "$ref": "/schemas/subnetworks_shared"
                }
            ]
        },
        "subnetworks_internal_https_load_balancer": {
            "$id": "/schemas/subnetworks_internal_https_load_balancer",
            "unevaluatedProperties": false,
            "allOf": [
                {
                    "$ref": "/schemas/subnetworks_shared"
                },
                {
                    "type": "object",
                    "properties": {
                        "role": {
                            "type": "string",
                            "enum": [
                                "BACKUP",
                                "ACTIVE"
                            ],
                            "default": "ACTIVE"
                        }
                    }
                }
            ]
        },
        "routes_shared": {
            "$id": "/schemas/routes_shared",
            "type": "object",
            "properties": {
                "destination": {
                    "type": "string",
                    "description": "IP space allocated to this subnetwork in CIDR format.",
                    "example": "192.168.0.0/24",
                    "pattern": "^([0-9]{1,3}\\.){3}[0-9]{1,3}\\/(([0-9]|[1-2][0-9]|3[0-2]))?$"
                },
                "priority": {
                    "type": "number",
                    "default": 1000
                },
                "tags": {
                    "type": "array",
                    "items": {
                        "type": "string"
                    },
                    "default": []
                },
                "next_hop_type": true
            },
            "required": [
                "destination"
            ]
        },
        "routes/nexthop/address": {
            "$id": "/schemas/routes/nexthop/address",
            "unevaluatedProperties": false,
            "allOf": [
                {
                    "$ref": "/schemas/routes_shared"
                },
                {
                    "type": "object",
                    "properties": {
                        "next_hop_address_panda": {
                            "type": "string",
                            "example": "192.168.0.253",
                            "pattern": "^([0-9]{1,3}\\.){3}[0-9]{1,3}$"
                        }
                    },
                    "required": [
                        "next_hop_address_panda"
                    ]
                }
            ]
        },
        "routes_nexthop_internet_gateway": {
            "$id": "/schemas/routes_nexthop_internet_gateway",
            "unevaluatedProperties": false,
            "anyOf": [
                {
                    "$ref": "/schemas/routes_shared"
                }
            ]
        },
        "regions": {
            "$id": "/schemas/regions",
            "type": "string",
            "example": "US-CENTRAL1",
            "enum": [
                "ASIA-EAST1",
                "ASIA-EAST2",
                "ASIA-NORTHEAST1",
                "ASIA-NORTHEAST2",
                "ASIA-NORTHEAST3",
                "ASIA-SOUTH1",
                "ASIA-SOUTH2",
                "ASIA-SOUTHEAST1",
                "ASIA-SOUTHEAST2",
                "AUSTRALIA-SOUTHEAST1",
                "AUSTRALIA-SOUTHEAST2",
                "EUROPE-CENTRAL2",
                "EUROPE-NORTH1",
                "EUROPE-WEST1",
                "EUROPE-WEST2",
                "EUROPE-WEST3",
                "EUROPE-WEST4",
                "EUROPE-WEST6",
                "NORTHAMERICA-NORTHEAST1",
                "NORTHAMERICA-NORTHEAST2",
                "SOUTHAMERICA-EAST1",
                "US-CENTRAL1",
                "US-EAST1",
                "US-EAST4",
                "US-WEST1",
                "US-WEST2",
                "US-WEST3",
                "US-WEST4"
            ]
        }
    }
}